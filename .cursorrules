# Reglas del Proyecto - BankFlowDashboard

## PocketBase - Mejores Pr√°cticas y Prevenci√≥n de Errores

### ‚ö†Ô∏è REGLAS CR√çTICAS PARA POCKETBASE

1. **Manejo de URLs de PocketBase**
   - SIEMPRE verificar si la URL termina en `/_/` antes de usar el SDK
   - Para el SDK de PocketBase: REMOVER `/_/` del final de la URL
   - Para la API REST: MANTENER `/_/` si est√° presente
   - Ejemplo correcto: `https://estadosdecuenta-db.david-cloud.online` (sin `/_/`) para SDK
   - Ejemplo correcto: `https://estadosdecuenta-db.david-cloud.online/_/` para API REST

2. **Autenticaci√≥n de Administrador**
   - SIEMPRE verificar que `POCKETBASE_ADMIN_EMAIL` y `POCKETBASE_ADMIN_PASSWORD` est√©n configuradas
   - Usar `_superusers` collection para autenticaci√≥n en PocketBase v0.23+
   - M√©todo: `pb.collection('_superusers').authWithPassword(email, password)`
   - SIEMPRE verificar `pb.authStore.isValid` antes de operaciones cr√≠ticas
   - Implementar manejo de errores de autenticaci√≥n con mensajes claros

3. **Creaci√≥n de Colecciones y Schemas**
   - NUNCA crear una colecci√≥n sin definir TODOS los campos del schema primero
   - SIEMPRE incluir todos los campos requeridos al crear la colecci√≥n
   - Usar `fields` (no `schema`) al actualizar colecciones existentes v√≠a API
   - Verificar que los campos se crearon correctamente despu√©s de la inicializaci√≥n
   - Campos requeridos para `transactions`: id_number, date, description, amount, type, category, merchant, currency

4. **Reglas de Acceso (API Rules)**
   - SIEMPRE configurar reglas de acceso al crear colecciones
   - Para desarrollo: dejar reglas vac√≠as (acceso completo) solo si PocketBase est√° protegido por firewall
   - Para producci√≥n: implementar reglas de autenticaci√≥n apropiadas
   - Verificar reglas despu√©s de crear/modificar colecciones

5. **Manejo de Errores Comunes**
   - "Only superusers can perform this action": Verificar autenticaci√≥n y reglas de acceso
   - "Collection not found": Verificar que la colecci√≥n existe antes de usarla
   - Campos vac√≠os en registros: Verificar que el schema tiene todos los campos definidos
   - Errores SSL: Configurar `NODE_TLS_REJECT_UNAUTHORIZED=0` solo en desarrollo, nunca en producci√≥n
   - Errores de conexi√≥n: Verificar URL, firewall, y que el servidor est√© en l√≠nea

6. **Operaciones Concurrentes**
   - Implementar locks para evitar m√∫ltiples llamadas simult√°neas a `getAllTransactions()`
   - Usar promesas compartidas para evitar duplicaci√≥n de requests
   - Limpiar locks despu√©s de completar operaciones

7. **Validaci√≥n de Datos**
   - SIEMPRE validar que los datos existen antes de mapearlos
   - Usar valores por defecto para campos opcionales (ej: currency = "MXN")
   - Sanitizar strings con `.trim()` antes de guardar
   - Validar tipos de datos (number, text, etc.) antes de insertar

8. **Scripts de Inicializaci√≥n**
   - SIEMPRE ejecutar `npm run init-pocketbase` despu√©s de configurar variables de entorno
   - Verificar que las colecciones se crearon correctamente con `npm run auditoria-pocketbase`
   - Si hay problemas, usar `npm run agregar-campos` para corregir schemas

9. **Variables de Entorno**
   - SIEMPRE verificar que `POCKETBASE_URL` est√° configurada antes de inicializar
   - Usar valores por defecto solo en desarrollo, nunca en producci√≥n
   - Documentar todas las variables de entorno requeridas

10. **Testing y Verificaci√≥n**
    - Despu√©s de cualquier cambio en PocketBase, ejecutar scripts de verificaci√≥n
    - Verificar autenticaci√≥n, colecciones, schemas y reglas de acceso
    - Probar operaciones CRUD b√°sicas despu√©s de cambios

### üìã CHECKLIST ANTES DE USAR POCKETBASE

- [ ] Variables de entorno configuradas (POCKETBASE_URL, POCKETBASE_ADMIN_EMAIL, POCKETBASE_ADMIN_PASSWORD)
- [ ] URL formateada correctamente (sin `/_/` para SDK, con `/_/` para API REST)
- [ ] Autenticaci√≥n verificada y funcionando
- [ ] Colecciones existen y tienen todos los campos del schema
- [ ] Reglas de acceso configuradas apropiadamente
- [ ] Manejo de errores implementado
- [ ] Locks para operaciones concurrentes implementados
- [ ] Validaci√≥n de datos antes de insertar/actualizar

### üö´ ERRORES COMUNES A EVITAR

1. ‚ùå Crear colecciones sin definir campos en el schema
2. ‚ùå Usar URL con `/_/` para el SDK de PocketBase
3. ‚ùå Olvidar verificar autenticaci√≥n antes de operaciones
4. ‚ùå No manejar errores de SSL en desarrollo
5. ‚ùå Permitir m√∫ltiples llamadas concurrentes sin locks
6. ‚ùå No validar datos antes de guardar
7. ‚ùå Olvidar configurar reglas de acceso
8. ‚ùå No verificar que las colecciones existen antes de usarlas

### üìö Referencias

- Documentaci√≥n de problemas: `SOLUCION_ERROR_POCKETBASE.md`, `SOLUCION_CAMPOS_VACIOS.md`
- Scripts de auditor√≠a: `server/auditoria-pocketbase.ts`
- Scripts de inicializaci√≥n: `server/init-pocketbase.ts`
- Implementaci√≥n de storage: `server/storage.ts`

